#include <ArduinoJson.h>
#include <HardwareSerial.h>


//  Grove geluidssensor 
const int soundSensorPin = 34; 

// mmWave sensor tafel 1
const int RX_PIN_1 = 16;
const int TX_PIN_1 = 17;
HardwareSerial SensorSerial1(2); 

// mmWave sensor tafel 2
const int RX_PIN_2 = 19;
const int TX_PIN_2 = 18;
HardwareSerial SensorSerial2(1); 

void setup() {
  Serial.begin(115200);
  
  // Standaard pinnen bij vermelden zodat het niet fout gaat
  SensorSerial1.begin(115200, SERIAL_8N1, RX_PIN_1, TX_PIN_1); 

  // Tafel 2 werkte al
  SensorSerial2.begin(115200, SERIAL_8N1, RX_PIN_2, TX_PIN_2);

  pinMode(soundSensorPin, INPUT);

  Serial.println("Systeem gestart. Wachten op sensor data...");
  delay(1000); 
}


void loop() {
  // Data ophalen
  int rawSound = analogRead(soundSensorPin);
  
  // Afstanden uitlezen
  int dist1 = readMmWaveDistance(SensorSerial1);
  int dist2 = readMmWaveDistance(SensorSerial2);

  // Status bepalen
  String status1 = determineStatus(dist1);
  String status2 = determineStatus(dist2);

  // Json maken
  StaticJsonDocument<256> doc;
  
  doc["tafel1"] = status1;
  doc["cm1"] = dist1;
  
  doc["tafel2"] = status2;
  doc["cm2"] = dist2;
  
  doc["rawSound"] = rawSound;

  // Versturen
  String output;
  serializeJson(doc, output);
  Serial.println(output);

  delay(500); 
}

// Hulpfuncties

String determineStatus(int distance) {
  if (distance <= 0) return "VRIJ"; 
  if (distance > 0 && distance < 10) return "BLOKKADE";
  if (distance >= 10 && distance < 70) return "BEZET";
  return "VRIJ";
}

int readMmWaveDistance(HardwareSerial &sensorSerial) {
  int distance = 0;
  if (sensorSerial.available()) {
    distance = sensorSerial.parseInt();
    while(sensorSerial.available()) {
      sensorSerial.read(); 
    }
  }
  return distance;
}
